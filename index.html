<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DATA SCIENCE TIME TABLE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 40px;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
            color: #fff;
        }

        /* --- Navigation Bar Styles --- */
        .navbar {
            background-color: #1a2a3a; /* Darker shade for the nav bar */
            padding: 15px 40px;
            display: flex;
            justify-content: flex-end; /* Align items to the right */
            align-items: center;
            margin-bottom: 40px; /* Space below the nav bar */
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 247, 255, 0.1);
        }

        .navbar ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex; /* For horizontal links */
        }

        .navbar li {
            margin-left: 30px; /* Space between links */
        }

        .navbar a {
            text-decoration: none;
            color: #00f7ff; /* Neon blue color for links */
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 500;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }

        .navbar a:hover {
            color: #fff; /* White on hover */
            text-shadow: 0 0 8px #00f7ff; /* Glow effect on hover */
        }
        /* --- End Navigation Bar Styles --- */

        h1 {
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            color: #00f7ff;
            margin-bottom: 40px;
            text-shadow: 0 0 10px #00f7ff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 50px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 247, 255, 0.15);
            background: #111827;
        }

        thead {
            background-color: #1f2937;
        }

        th, td {
            padding: 18px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 60px; /* Ensure cells have height */
            vertical-align: top;
        }

        th {
            color: #00f7ff;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        td {
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        td span {
            display: block;
            font-weight: bold;
        }

        td span.venue {
            font-size: 0.9rem;
            font-weight: normal;
            color: #ccc;
            margin-top: 4px;
        }

        td:hover {
            background-color: #1a2a3a;
            cursor: pointer;
        }

        .time-slot {
            background-color: #1f2937;
            color: #0ff;
            font-weight: 700;
        }
        
        .jumat {
            color: #00f7ff;
            font-style: italic;
            vertical-align: middle;
        }

        /* Course Colors */
        .MTH201 { color: #7f5af0; }
        .MTH203 { color: #ff6b6b; }
        .DTS201 { color: #ffd93d; }
        .DTS211 { color: #1dd3b0; }
        .MTH209 { color: #00b4d8; }
        .STA223 { color: #f15bb5; } /* New */
        .STA225 { color: #ff9f1c; } /* New */
        .NOT_FOUND { color: #aaaaaa; }


        .course-key {
            max-width: 850px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 0 20px rgba(0,247,255,0.1);
        }

        .course-key h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: #00f7ff;
            text-align: center;
            text-shadow: 0 0 8px #00f7ff;
        }

        .course-key ul {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 12px;
            font-size: 1rem;
        }

        .course-key li {
            background-color: rgba(255, 255, 255, 0.07);
            padding: 10px 15px;
            border-radius: 8px;
            color: #fff;
        }

        .course-key li strong {
            display: inline-block;
            width: 100px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: #111827;
            margin: 10% auto;
            padding: 30px;
            border-radius: 16px;
            width: 50%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
            border: 1px solid #00f7ff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0, 247, 255, 0.3);
            padding-bottom: 10px;
        }

        .modal-header h2 {
            font-family: 'Orbitron', sans-serif;
            color: #00f7ff;
            margin: 0;
            text-shadow: 0 0 8px #00f7ff;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        .modal-body {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .reminder-btn {
            background-color: #00f7ff;
            color: #111827;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.5);
        }

        .reminder-btn:hover {
            background-color: #00d9e0;
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.7);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #00f7ff;
            color: #111827;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 247, 255, 0.5);
            display: none;
            z-index: 1000;
            font-family: 'Orbitron', sans-serif;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <ul>
            <li><a href="profile.html">Profile</a></li>
        </ul>
    </nav>

    <h1>DATA SCIENCE 200 LEVEL TIME TABLE</h1>

    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Monday</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
                <th>Friday</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="time-slot">08:00–09:00</td>
                <td data-course-code="DTS211"><span class="DTS211">DTS211</span><span class="venue">S015</span></td>
                <td></td>
                <td></td>
                <td data-course-code="MTH201"><span class="MTH201">MTH201</span><span class="venue">LT 018</span></td>
                <td></td>
            </tr>
            <tr>
                <td class="time-slot">09:00–10:00</td>
                <td data-course-code="DTS211"><span class="DTS211">DTS211</span><span class="venue">S015</span></td>
                <td></td>
                <td></td>
                <td></td>
                <td data-course-code="MTH203"><span class="MTH203">MTH203</span><span class="venue">LT 009</span></td>
            </tr>
            <tr>
                <td class="time-slot">10:00–11:00</td>
                <td></td>
                <td data-course-code="MTH201 MTH203"><span class="MTH201">MTH201</span> / <span class="MTH203">MTH203</span><span class="venue">LT 026</span></td>
                <td></td>
                <td data-course-code="DTS201"><span class="DTS201">DTS201</span><span class="venue">S 024</span></td>
                <td data-course-code="MTH203"><span class="MTH203">MTH203</span><span class="venue">LT 009</span></td>
            </tr>
            <tr>
                <td class="time-slot">11:00–12:00</td>
                <td></td>
                <td></td>
                <td data-course-code="MTH209"><span class="MTH209">MTH209</span><span class="venue">LT 009</span></td>
                <td data-course-code="DTS201"><span class="DTS201">DTS201</span><span class="venue">S 024</span></td>
                <td></td>
            </tr>
            <tr>
                <td class="time-slot">12:00–13:00</td>
                <td></td>
                <td></td>
                <td data-course-code="MTH203"><span class="MTH203">MTH203</span><span class="venue">LT 009</span></td>
                <td data-course-code="STA223"><span class="STA223">STA 223</span><span class="venue">E 303</span></td>
                <td></td>
            </tr>
            <tr>
                <td class="time-slot">13:00–14:00</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="jumat">JUMAT SERVICE</td>
            </tr>
            <tr>
                <td class="time-slot">14:00–15:00</td>
                <td data-course-code="DTS201"><span class="DTS201">DTS201</span><span class="venue">S015</span></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="jumat">JUMAT SERVICE</td>
            </tr>
            <tr>
                <td class="time-slot">15:00–16:00</td>
                <td data-course-code="DTS201 MTH209" style="line-height: 1.6;">
                    <span class="DTS201">DTS201</span><span class="venue">S015</span>
                    <hr style="border-color: rgba(255,255,255,0.1); margin: 8px 0;">
                    <span class="MTH209">MTH209</span><span class="venue">LT 009</span>
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td class="time-slot">16:00–17:00</td>
                <td data-course-code="MTH209"><span class="MTH209">MTH209</span><span class="venue">LT 009</span></td>
                <td></td>
                <td data-course-code="STA225"><span class="STA225">STA 225</span><span class="venue">S015</span></td>
                <td></td>
                <td data-course-code="STA223"><span class="STA223">STA 223</span><span class="venue">S 024</span></td>
            </tr>
            <tr>
                <td class="time-slot">17:00–18:00</td>
                <td></td>
                <td></td>
                <td data-course-code="STA225"><span class="STA225">STA 225</span><span class="venue">S015</span></td>
                <td></td>
                <td data-course-code="STA223"><span class="STA223">STA 223</span><span class="venue">S 024</span></td>
            </tr>
        </tbody>
    </table>

    <div class="course-key">
        <h2>Course Code Key</h2>
        <ul>
            <li><strong class="DTS211">DTS211</strong> – Introduction To R Programming (2 Units)</li>
            <li><strong class="MTH201">MTH201</strong> – Mathematical Methods I (2 Units)</li>
            <li><strong class="MTH203">MTH203</strong> – Sets, Logic And Algebra I (2 Units)</li>
            <li><strong class="DTS201">DTS201</strong> – Introduction To Data Science (2 Units)</li>
            <li><strong class="MTH209">MTH209</strong> – Introduction To Numerical Analysis (2 Units)</li>
            <li><strong class="STA223">STA 223</strong> – Categorical Data Analysis (Found as LAG-STA 223)</li>
            <li><strong class="STA225">STA 225</strong> – Statistical Quality Control (Found as LAG-STA 225)</li>
            <li style="background-color: #331a1a;"><strong class="NOT_FOUND">COS201</strong> – Computer Programming I (3 Units) - Not Found</li>
            <li style="background-color: #331a1a;"><strong class="NOT_FOUND">CSC203</strong> – Discrete Structures (2 Units) - Not Found</li>
            <li style="background-color: #331a1a;"><strong class="NOT_FOUND">ENT241</strong> – Entrepreneurship And Innovation (2 Units) - Not Found</li>
            <li style="background-color: #331a1a;"><strong class="NOT_FOUND">LAG-CSC103</strong> – Fundamental Of Programming (3 Units) - Not Found</li>
        </ul>
    </div>

    <div id="reminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalCourseCode"></h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p id="modalCourseName"></p>
                <p><strong>Day:</strong> <span id="modalDay"></span></p>
                <p><strong>Time:</strong> <span id="modalTime"></span></p>
                <p><strong>Venue:</strong> <span id="modalVenue"></span></p>
            </div>
            <div class="modal-footer">
                <button class="reminder-btn" id="setReminder">Set Reminder</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        Reminder set successfully!
    </div>

    <script>
        // Course data with venues
        const courseData = {
            "DTS211": {
                name: "Introduction To R Programming",
                venues: {
                    "Monday 08:00-09:00": "S015",
                    "Monday 09:00-10:00": "S015"
                }
            },
            "MTH201": {
                name: "Mathematical Methods I",
                venues: {
                    "Tuesday 10:00-11:00": "LT 026",
                    "Thursday 08:00-09:00": "LT 018"
                }
            },
            "MTH203": {
                name: "Sets, Logic And Algebra I",
                venues: {
                    "Tuesday 10:00-11:00": "LT 026",
                    "Wednesday 12:00-13:00": "LT 009",
                    "Friday 09:00-10:00": "LT 009",
                    "Friday 10:00-11:00": "LT 009"
                }
            },
            "DTS201": {
                name: "Introduction To Data Science",
                venues: {
                    "Monday 10:00-11:00": "S 024",
                    "Monday 11:00-12:00": "S 024",
                    "Monday 14:00-15:00": "S015",
                    "Monday 15:00-16:00": "S015"
                }
            },
            "MTH209": {
                name: "Introduction To Numerical Analysis",
                venues: {
                    "Monday 15:00-16:00": "LT 009",
                    "Monday 16:00-17:00": "LT 009",
                    "Wednesday 11:00-12:00": "LT 009"
                }
            },
            "STA223": {
                name: "Categorical Data Analysis",
                venues: {
                    "Thursday 12:00-13:00": "E 303",
                    "Friday 16:00-17:00": "S 024",
                    "Friday 17:00-18:00": "S 024"
                }
            },
            "STA225": {
                name: "Statistical Quality Control",
                venues: {
                    "Wednesday 16:00-17:00": "S015",
                    "Wednesday 17:00-18:00": "S015"
                }
            }
        };

        // Get the modal
        const modal = document.getElementById("reminderModal");
        const span = document.getElementsByClassName("close")[0];
        const notification = document.getElementById("notification");

        // When user clicks on a course cell
        document.querySelectorAll('td[data-course-code]').forEach(courseCell => {
            courseCell.addEventListener('click', function() {
                const courseCodes = this.dataset.courseCode.split(' ');
                const mainCourseCode = courseCodes[0]; // Just use the first course for the modal
                
                if (!mainCourseCode || mainCourseCode === "NOT_FOUND") return; // Don't open modal for "Not Found"

                const courseRow = this.parentElement;
                const table = this.closest('table');
                const dayColumnIndex = this.cellIndex;
                const headerCells = table.querySelector('thead tr').children;
                const dayOfWeek = headerCells[dayColumnIndex].textContent.trim();
                
                const timeWithEnDash = courseRow.children[0].textContent.trim();
                const timeWithHyphen = timeWithEnDash.replace('–', '-');
                const fullDayTimeKey = `${dayOfWeek} ${timeWithHyphen}`;
                
                const allCodes = [];
                const allNames = [];
                const allVenues = [];

                courseCodes.forEach(code => {
                    const courseDetails = courseData[code];
                    let venue = "Not specified";
                    let courseName = "Unknown Course";

                    if (courseDetails) {
                        courseName = courseDetails.name;
                        if (courseDetails.venues && courseDetails.venues[fullDayTimeKey]) {
                            venue = courseDetails.venues[fullDayTimeKey];
                        } else {
                            // Fallback for 2-hour slots
                            const [startTime, endTime] = timeWithHyphen.split('-');
                            const prevHour = (parseInt(startTime.split(':')[0]) - 1).toString().padStart(2, '0') + ":" + startTime.split(':')[1];
                            const prevHourKey = `${dayOfWeek} ${prevHour}-${startTime}`;
                            if(courseDetails.venues && courseDetails.venues[prevHourKey]) {
                                venue = courseDetails.venues[prevHourKey];
                            } else {
                                console.warn(`Venue not found for ${code} at "${fullDayTimeKey}".`);
                            }
                        }
                    }
                    allCodes.push(code);
                    allNames.push(courseName);
                    allVenues.push(venue);
                });


                document.getElementById("modalCourseCode").textContent = allCodes.join(' / ');
                document.getElementById("modalCourseName").textContent = allNames.join(' / ');
                document.getElementById("modalDay").textContent = dayOfWeek;
                document.getElementById("modalTime").textContent = timeWithEnDash;
                document.getElementById("modalVenue").textContent = allVenues.join(' / ');

                document.getElementById("setReminder").dataset.course = JSON.stringify({
                    code: allCodes.join(' / '),
                    name: allNames.join(' / '),
                    day: dayOfWeek,
                    time: timeWithEnDash,
                    venue: allVenues.join(' / '),
                    fullDayTime: fullDayTimeKey
                });
                modal.style.display = "block";
            });
        });

        // Close modal handlers
        span.onclick = function() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) modal.style.display = "none"; }

        // Enhanced reminder system
        document.getElementById("setReminder").addEventListener('click', async function() {
            console.log("Set Reminder button clicked."); // Log 1: Button clicked
            const courseInfoString = this.dataset.course;

            if (!courseInfoString) {
                console.error("Error: No course data found on the reminder button's dataset.");
                showNotification("Error: Course data missing for reminder.", false);
                return;
            }
            console.log("Course data string from dataset:", courseInfoString); // Log 2: Raw data

            let courseInfo;
            try {
                courseInfo = JSON.parse(courseInfoString);
            } catch (e) {
                console.error("Error parsing course data from dataset:", e, courseInfoString);
                showNotification("Error: Could not read course data for reminder.", false);
                return;
            }
            console.log("Parsed courseInfo for reminder:", courseInfo); // Log 3: Parsed data

            if (!courseInfo || typeof courseInfo !== 'object') {
                console.error("Error: Parsed course data is invalid.", courseInfo);
                showNotification("Error: Invalid course data for reminder.", false);
                return;
            }


            if (!window.Notification) {
                console.error("Browser does not support notifications.");
                showNotification("Sorry, your browser does not support notifications.", false);
                return;
            }

            try {
                console.log("Current Notification.permission state:", Notification.permission); // Log 4: Initial permission state
                if (Notification.permission !== "granted") {
                    console.log("Requesting notification permission..."); // Log 5: Attempting to request
                    const permission = await Notification.requestPermission();
                    console.log("Notification permission request result:", permission); // Log 6: Result of request
                    if (permission !== "granted") {
                        showNotification("Please enable notifications to get weekly reminders.", false);
                        console.log("Notification permission was not granted. Reminder not set."); // Log 7: Permission denied/dismissed
                        return;
                    }
                }

                console.log("Notification permission is granted."); // Log 8: Permission confirmed
                saveReminder(courseInfo);
                console.log("Reminder saved to localStorage.", courseInfo); // Log 9: Saved to localStorage

                scheduleWeeklyReminder(courseInfo);
                console.log("Weekly reminder scheduled.", courseInfo); // Log 10: Scheduling attempted

                showNotification(`Weekly reminder set for ${courseInfo.code}.`, true);
                modal.style.display = "none";

            } catch (error) {
                console.error("Error in setReminder process:", error); // Catch all for other errors
                showNotification("Failed to set reminder. Check console for details.", false);
            }
        });

        function saveReminder(courseInfo) {
            const reminders = JSON.parse(localStorage.getItem('courseReminders') || '[]');
            const exists = reminders.some(reminder =>
                reminder.code === courseInfo.code &&
                reminder.fullDayTime === courseInfo.fullDayTime
            );
            if (!exists) {
                reminders.push(courseInfo);
                localStorage.setItem('courseReminders', JSON.stringify(reminders));
                console.log("Reminder newly added to localStorage:", courseInfo);
            } else {
                console.log("Reminder already exists in localStorage:", courseInfo);
            }
        }

        function scheduleWeeklyReminder(courseInfo) {
            console.log("Attempting to schedule weekly reminder for:", courseInfo);
            const dayMap = {
                "Monday": 1, "Tuesday": 2, "Wednesday": 3,
                "Thursday": 4, "Friday": 5, "Saturday": 6, "Sunday": 0
            };
            const dayNumber = dayMap[courseInfo.day];
            if (dayNumber === undefined) {
                console.error("Invalid day for reminder:", courseInfo.day, courseInfo);
                return;
            }

            const [startTimeString] = courseInfo.time.split('–'); // Expects en-dash
            const [hours, minutes] = startTimeString.split(':').map(Number);

            if (isNaN(hours) || isNaN(minutes)) {
                console.error("Invalid time for reminder parsing:", courseInfo.time, courseInfo);
                return;
            }
            console.log(`Parsed time for reminder: DayNumber=${dayNumber}, Hours=${hours}, Minutes=${minutes}`);

            const now = new Date();
            const nextDate = new Date(); // Create new Date object for manipulation

            nextDate.setHours(hours, minutes, 0, 0); // Set time for today initially

            let daysToAdd = (dayNumber - now.getDay() + 7) % 7;

            // If target day is today, but time has already passed, schedule for next week
            if (daysToAdd === 0 && (now.getHours() > hours || (now.getHours() === hours && now.getMinutes() >= minutes))) {
                console.log("Target time today has passed, scheduling for next week.");
                daysToAdd = 7;
            }
            
            nextDate.setDate(now.getDate() + daysToAdd); // Set the correct date
            console.log(`Current time: ${now.toString()}`);
            console.log(`Calculated next reminder date: ${nextDate.toString()}`);

            const timeUntilFirst = nextDate.getTime() - now.getTime();
            console.log(`Time until first notification (ms): ${timeUntilFirst}`);

            if (timeUntilFirst < 0) {
                console.error("Calculated timeUntilFirst is negative. This indicates an issue in date calculation.", { courseInfo, nowDate: now.toString(), nextDateCalc: nextDate.toString() });
            }

            // Schedule the first notification
            setTimeout(() => {
                console.log("Firing scheduled notification for:", courseInfo);
                showNotification(`Reminder: ${courseInfo.code} at ${courseInfo.time} in ${courseInfo.venue}`, true);

                // Then set weekly interval
                console.log("Setting up weekly interval for:", courseInfo);
                setInterval(() => {
                    console.log("Firing weekly interval notification for:", courseInfo);
                    showNotification(`Reminder: ${courseInfo.code} at ${courseInfo.time} in ${courseInfo.venue}`, true);
                }, 7 * 24 * 60 * 60 * 1000); // 1 week interval
            }, Math.max(0, timeUntilFirst)); // Ensure delay is not negative
        }

        function showNotification(message, isSuccess) {
            if (Notification.permission === "granted" && window.Notification) { // Also check window.Notification support
                try {
                    new Notification("Class Reminder", {
                        body: message,
                        icon: isSuccess ? "https://cdn-icons-png.flaticon.com/512/190/190411.png" : "https://cdn-icons-png.flaticon.com/512/1828/1828843.png"
                    });
                } catch (e) {
                    console.error("Error creating browser notification:", e);
                }
            }

            notification.textContent = message;
            notification.style.backgroundColor = isSuccess ? "#00f7ff" : "#ff6b6b";
            notification.style.display = "block";
            setTimeout(() => {
                notification.style.display = "none";
            }, 3000);
        }

        window.addEventListener('load', () => {
            console.log("Page loaded. Checking for existing reminders and notification permission.");
            if (window.Notification && Notification.permission === "granted") {
                const reminders = JSON.parse(localStorage.getItem('courseReminders') || '[]');
                console.log(`Found ${reminders.length} reminders in localStorage to reschedule.`);
                reminders.forEach(reminder => {
                    console.log("Rescheduling reminder from localStorage on load:", reminder);
                    scheduleWeeklyReminder(reminder);
                });
            } else {
                console.log("Notification permission not granted on load, or Notifications not supported. Stored reminders will not be automatically scheduled.");
            }
        });
    </script>
</body>
</html>
